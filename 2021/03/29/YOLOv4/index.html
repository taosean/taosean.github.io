<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="YOLOv4"><meta name="keywords" content="目标检测,yolo,CSP,CutMix,数据增强,DropBlock,GIoU,DIoU,CIoU,SPP,PAN"><meta name="author" content="taosean"><meta name="copyright" content="taosean"><title>YOLOv4 | taosean's 学习之旅</title><link rel="shortcut icon" href="/img/avatar.jpg"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://v1.hitokoto.cn/?encode=js&amp;charset=utf-8&amp;select=.footer_custom_text" defer></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '3.7.1'
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-序言"><span class="toc-number">1.</span> <span class="toc-text"> 0. 序言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-yolo-v4-的选择"><span class="toc-number">2.</span> <span class="toc-text"> 1. YOLO v4 的选择</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-各部分详细解读"><span class="toc-number">3.</span> <span class="toc-text"> 2. 各部分详细解读</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-backbone"><span class="toc-number">3.1.</span> <span class="toc-text"> 2.1 Backbone</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#211-densenet"><span class="toc-number">3.1.1.</span> <span class="toc-text"> 2.1.1 DenseNet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#212-cross-stage-partial-connections-csp"><span class="toc-number">3.1.2.</span> <span class="toc-text"> 2.1.2 Cross-Stage-Partial-connections (CSP)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#213-cspdarknet53"><span class="toc-number">3.1.3.</span> <span class="toc-text"> 2.1.3 CSPDarknet53</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-neck"><span class="toc-number">3.2.</span> <span class="toc-text"> 2.2 Neck</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#221-feature-pyramid-networks-fpn"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 2.2.1 Feature Pyramid Networks (FPN)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#222-spp-spatial-pyramid-pooling-layer"><span class="toc-number">3.2.2.</span> <span class="toc-text"> 2.2.2 SPP (spatial pyramid pooling layer)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#223-yolo-with-spp"><span class="toc-number">3.2.3.</span> <span class="toc-text"> 2.2.3 YOLO with SPP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#224-path-aggregation-network-pan"><span class="toc-number">3.2.4.</span> <span class="toc-text"> 2.2.4 Path Aggregation Network (PAN)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#225-spatial-attention-module-sam"><span class="toc-number">3.2.5.</span> <span class="toc-text"> 2.2.5 Spatial Attention Module (SAM)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-bag-of-freebies-bof-for-backbone"><span class="toc-number">3.3.</span> <span class="toc-text"> 2.3 Bag of Freebies (BoF) for backbone</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#231-cutmix-数据增强"><span class="toc-number">3.3.1.</span> <span class="toc-text"> 2.3.1 CutMix 数据增强</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#232-mosaic-数据增强"><span class="toc-number">3.3.2.</span> <span class="toc-text"> 2.3.2 Mosaic 数据增强</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#233-dropblock-正则化"><span class="toc-number">3.3.3.</span> <span class="toc-text"> 2.3.3 DropBlock 正则化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#234-类别标签平滑class-label-smoothing"><span class="toc-number">3.3.4.</span> <span class="toc-text"> 2.3.4 类别标签平滑(Class label smoothing)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-bag-of-specials-bos-for-backbone"><span class="toc-number">3.4.</span> <span class="toc-text"> 2.4 Bag of Specials (BoS) for backbone</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#241-mish-激活"><span class="toc-number">3.4.1.</span> <span class="toc-text"> 2.4.1 Mish 激活</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#242-multi-input-weighted-residual-connections-miwrc"><span class="toc-number">3.4.2.</span> <span class="toc-text"> 2.4.2 Multi-input weighted residual connections (MiWRC)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#25-bag-of-freebies-bof-for-detector"><span class="toc-number">3.5.</span> <span class="toc-text"> 2.5 Bag of Freebies (BoF) for detector</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#251-ciou-loss"><span class="toc-number">3.5.1.</span> <span class="toc-text"> 2.5.1 CIoU-loss</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#252-cmbn"><span class="toc-number">3.5.2.</span> <span class="toc-text"> 2.5.2 CmBN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#253-self-adversarial-training-sat"><span class="toc-number">3.5.3.</span> <span class="toc-text"> 2.5.3 Self-Adversarial Training (SAT)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#254-消除网格敏感性eliminate-grid-sensitivity"><span class="toc-number">3.5.4.</span> <span class="toc-text"> 2.5.4 消除网格敏感性(Eliminate grid sensitivity)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#255-multiple-anchors-for-a-single-ground-truth"><span class="toc-number">3.5.5.</span> <span class="toc-text"> 2.5.5 Multiple anchors for a single ground truth</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#256-cosine-annealing-scheduler"><span class="toc-number">3.5.6.</span> <span class="toc-text"> 2.5.6 Cosine annealing scheduler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#257-基于遗传算法的超参数选择进化算法"><span class="toc-number">3.5.7.</span> <span class="toc-text"> 2.5.7 基于遗传算法的超参数选择(进化算法)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#258-随机训练形状"><span class="toc-number">3.5.8.</span> <span class="toc-text"> 2.5.8 随机训练形状</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#26-bag-of-specials-bos-for-detector"><span class="toc-number">3.6.</span> <span class="toc-text"> 2.6 Bag of Specials (BoS) for detector</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#261-diou-nms"><span class="toc-number">3.6.1.</span> <span class="toc-text"> 2.6.1 DIoU-NMS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-yolo-v4-网络结构分析"><span class="toc-number">4.</span> <span class="toc-text"> 3. YOLO v4 网络结构分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#引用"><span class="toc-number">5.</span> <span class="toc-text"> 引用</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.jpg"></div><div class="author-info__name text-center">taosean</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/taosean">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">46</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">137</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">友情链接</div><a class="author-info-links__name text-center" href="https://github.com/xiaolai">李笑来</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/img/top_img.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">taosean's 学习之旅</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">主页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a><a class="site-page" href="/about">关于</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">YOLOv4</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-03-29</time><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">4.3k</span><span class="post-meta__separator">|</span><span>阅读时长: 16 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>本文主要记录了关于 yolo v4 的内容。</p>
<a id="more"></a>
<h1 id="0-序言"><a class="markdownIt-Anchor" href="#0-序言"></a> 0. 序言</h1>
<p>Yolo v4 论文主要由 <strong>目标检测网络构成</strong>，<strong>Bag of freebies</strong>, <strong>Bag of specials</strong> 这三部分组成。</p>
<p>作者首先详细列举了目前已有的目标检测网络构成部件，以及已有的 Bag of freebies, Bag of specials, 然后分别从这三大部分中选取合适的内容，组成了 Yolo v4.</p>
<p>列举的三大部分如下面三张图</p>
<p><img src="detector-parts.png" alt="目标检测网络的构成部件"></p>
<p><img src="freebies.png" alt="Bag of freebies"></p>
<p><img src="specials.png" alt="Bag of specials"></p>
<h1 id="1-yolo-v4-的选择"><a class="markdownIt-Anchor" href="#1-yolo-v4-的选择"></a> 1. YOLO v4 的选择</h1>
<p>YOLO v4 对各个部分的选择如下图所示</p>
<p><img src="selections.png" alt="YOLO v4 的选择"></p>
<h1 id="2-各部分详细解读"><a class="markdownIt-Anchor" href="#2-各部分详细解读"></a> 2. 各部分详细解读</h1>
<h2 id="21-backbone"><a class="markdownIt-Anchor" href="#21-backbone"></a> 2.1 Backbone</h2>
<h3 id="211-densenet"><a class="markdownIt-Anchor" href="#211-densenet"></a> 2.1.1 DenseNet</h3>
<p>Transition layer 由 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">1\times1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> 的卷积和 pooling 组成，分别用来降低通道数和空间尺寸。</p>
<p><img src="denseblock.jpeg" alt="DenseBlock"></p>
<p><img src="densenet.png" alt="DenseNet"></p>
<h3 id="212-cross-stage-partial-connections-csp"><a class="markdownIt-Anchor" href="#212-cross-stage-partial-connections-csp"></a> 2.1.2 Cross-Stage-Partial-connections (CSP)</h3>
<p>CSP 可以用在不同的网络上，下面的图展示了在 DenseNet 上使用 CSP 的结构。</p>
<p>CSPNet 将输入分成两部分 (沿通道分开)，一部分经过 DenseBlock 的处理，另一部分直接跳过处理，输入最后的输出层。</p>
<p><img src="CSP1.jpeg" alt="CSP Block"></p>
<p><img src="CSP2.png" alt="CSPNet"></p>
<h3 id="213-cspdarknet53"><a class="markdownIt-Anchor" href="#213-cspdarknet53"></a> 2.1.3 CSPDarknet53</h3>
<p>YOLO v4 使用 Darknet53 + CSP 连接组成的 CSPDarknet53 作为 backbone.</p>
<p><img src="CSPDarknet53.png" alt="YOLO v4 网络结构"></p>
<h2 id="22-neck"><a class="markdownIt-Anchor" href="#22-neck"></a> 2.2 Neck</h2>
<h3 id="221-feature-pyramid-networks-fpn"><a class="markdownIt-Anchor" href="#221-feature-pyramid-networks-fpn"></a> 2.2.1 Feature Pyramid Networks (FPN)</h3>
<p><img src="FPN.png" alt="FPN"></p>
<h3 id="222-spp-spatial-pyramid-pooling-layer"><a class="markdownIt-Anchor" href="#222-spp-spatial-pyramid-pooling-layer"></a> 2.2.2 SPP (spatial pyramid pooling layer)</h3>
<p><img src="SPP.jpeg" alt="原始的SPP"></p>
<h3 id="223-yolo-with-spp"><a class="markdownIt-Anchor" href="#223-yolo-with-spp"></a> 2.2.3 YOLO with SPP</h3>
<p>YOLO 中的 SPP 和本来的作用有点不一样，YOLO 中的 SPP 使用不同的 pooling 层对输入进行池化，但是不改变空间尺寸。然后不同 pooling 层得到的结果和原始的输入都 concatenate 在一起。</p>
<p><img src="SPP-yolo.jpeg" alt="YOLO 中的 SPP"></p>
<h3 id="224-path-aggregation-network-pan"><a class="markdownIt-Anchor" href="#224-path-aggregation-network-pan"></a> 2.2.4 Path Aggregation Network (PAN)</h3>
<p>下图是目标检测的 Path Aggregation Network(PAN)。 自底向上的路径 (b) 被扩展，使低层信息更容易传播到顶层。 在 FPN 中，局部空间信息在红色箭头中向上传递。 虽然在图中没有清楚地显示，但是红色的路径穿过了大约 <code>100</code> 多层。 PAN 引入了一条简捷的路径(绿色路径) ，只需要大约 <code>10</code> 层就可以到达顶层 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>N</mi><mn>5</mn></msub></mrow><annotation encoding="application/x-tex">N_5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em;"><span style="top:-2.5500000000000003em;margin-left:-0.10903em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 。 <strong>这种短路概念使细粒度的本地化信息可用于顶层</strong>。</p>
<p><img src="PAN.png" alt="PAN 结构"></p>
<p><img src="view-pan.jpeg" alt="另一种看待 PAN 的方法"></p>
<p>不过在 YOLOv4 中，特征图不是加上邻居层，而是 concate 在一起。</p>
<p><img src="modified-pan.jpg" alt="YOLO v4 中修改过的 PAN"></p>
<h3 id="225-spatial-attention-module-sam"><a class="markdownIt-Anchor" href="#225-spatial-attention-module-sam"></a> 2.2.5 Spatial Attention Module (SAM)</h3>
<p>注意力 (Attention) 在 DL 设计中有着广泛的应用。 在 SAM 中，最大池化和平均池化分别应用于输入特征图，生成两组特征图。 这些结果被输入到一个卷积层，然后经过 sigmoid 函数，以产生空间注意力。</p>
<p><img src="SAM.jpeg" alt="SAM 模块"></p>
<p>对应 空间注意力模块 (SAM)，也有 通道注意力模块 (CAM)</p>
<p><img src="CAM.png" alt="CAM 模块"></p>
<p>在 YOLOv4 中，使用了一个修改的 SAM，没有应用最大和平均池化。</p>
<p><img src="modified-sam.jpeg" alt="YOLO v4 中 SAM"></p>
<p>在 YOLO v4 中，FPN 概念逐渐被修改版的 SPP和 PAN 实现/取代。</p>
<h2 id="23-bag-of-freebies-bof-for-backbone"><a class="markdownIt-Anchor" href="#23-bag-of-freebies-bof-for-backbone"></a> 2.3 Bag of Freebies (BoF) for backbone</h2>
<p>YOLOv4 backbone 的 BoF 特性包括:</p>
<ul>
<li>CutMix 和 Mosaic 数据增强</li>
<li>DropBlock 正则化</li>
<li>类别标签平滑</li>
</ul>
<h3 id="231-cutmix-数据增强"><a class="markdownIt-Anchor" href="#231-cutmix-数据增强"></a> 2.3.1 CutMix 数据增强</h3>
<p>Cutout 数据增强删除图像的一个区域(见下图)。 <strong>这迫使模型在进行分类时不要对特定特性过于自信</strong>。 然而这样的话，图像的一部分充满了没用的信息，这是一种浪费。 在 CutMix 中，图像的一部分被剪切并粘贴到另一个图像上。 Ground truth 标签会根据补丁的面积按比例重新调整，例如 <code>0.6</code> 像狗，<code>0.4</code> 像猫。</p>
<p><img src="cutmix.jpeg" alt="CutMix 与其他方法效果比较"></p>
<p>从概念上讲，CutMix 对于一个对象可能由什么组成有更广阔的视野。 CutOut 区域迫使模型学习目标分类的不同特征集合。 这样可以避免过度自信。 由于该区域被替换为另一个图像，图像中的信息量和训练效率也不会受到显著影响。</p>
<h3 id="232-mosaic-数据增强"><a class="markdownIt-Anchor" href="#232-mosaic-数据增强"></a> 2.3.2 Mosaic 数据增强</h3>
<p>Mosaic 是一种数据增强方法，组合了 4 个训练图像到一个训练图像中(而不是 CutMix 中的2个)。 这增强了对其正常 context 之外的对象的检测。 此外，每个 mini-batch 都包含更大数量的图像 (4x)，因此减少了估计均值和方差时对大的 mini-batch 的需求。</p>
<p><img src="mosaic.jpeg" alt="Mosaic 增强示意图"></p>
<h3 id="233-dropblock-正则化"><a class="markdownIt-Anchor" href="#233-dropblock-正则化"></a> 2.3.3 DropBlock 正则化</h3>
<p>在全连接层中，我们可以应用 dropout 强制模型从各种特征中学习，而不是对一些特征过于自信。然而这可能对卷积层无效。相邻位置是高度相关的。所以即使有些像素被去掉了(下面的中图) ，空间信息仍然可以被检测到。 DropBlock 正则化基于一个类似的概念，但适用于卷积层。</p>
<p><img src="dropblock.png" alt="DropBlock"></p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><msub><mi>k</mi><mi>s</mi></msub><mi>i</mi><mi>z</mi><mi>e</mi><mo>×</mo><mi>b</mi><mi>l</mi><mi>o</mi><mi>c</mi><msub><mi>k</mi><mi>s</mi></msub><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">block_size × block_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord mathdefault">b</span><span class="mord mathdefault" style="margin-right:0.01968em;">l</span><span class="mord mathdefault">o</span><span class="mord mathdefault">c</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.03148em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right:0.04398em;">z</span><span class="mord mathdefault">e</span></span></span></span> 大小的块被整块删除，而不是删掉单独的像素。</p>
<p><img src="dropblock2.jpg" alt="dropblock算法"></p>
<h3 id="234-类别标签平滑class-label-smoothing"><a class="markdownIt-Anchor" href="#234-类别标签平滑class-label-smoothing"></a> 2.3.4 类别标签平滑(Class label smoothing)</h3>
<p>每当你觉得自己绝对正确的时候，你很可能是错的。 100% 相信一个预测可能会显示出这个模型是在记忆数据而不是在学习。 标签平滑将预测的目标上限调整为一个较低的值，比如 <code>0.9</code>。 它将使用这个值而不是 <code>1.0</code> 来计算损失。 这个概念减轻了 overfitting 问题。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p = tf.placeholder(tf.float32, shape=[<span class="keyword">None</span>, <span class="number">10</span>])</span><br><span class="line"><span class="comment"># Use 0.9 instead of 1.0.</span></span><br><span class="line">feed_dict = &#123;</span><br><span class="line">  p: [[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.9</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]] <span class="comment"># Image with label "3"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># logits_real_image is the logits calculated by </span></span><br><span class="line"><span class="comment"># the discriminator for real images.</span></span><br><span class="line">d_real_loss = tf.nn.sigmoid_cross_entropy_with_logits(</span><br><span class="line">                    labels=p, logits=logits_real_image)</span><br></pre></td></tr></table></figure>
<h2 id="24-bag-of-specials-bos-for-backbone"><a class="markdownIt-Anchor" href="#24-bag-of-specials-bos-for-backbone"></a> 2.4 Bag of Specials (BoS) for backbone</h2>
<p>YOLOv4 backbone 的 BoS 特性包括:</p>
<ul>
<li>Mish 激活</li>
<li>Cross-stage partial connections (CSP)</li>
<li>Multi-input weighted residual connections (MiWRC)</li>
</ul>
<h3 id="241-mish-激活"><a class="markdownIt-Anchor" href="#241-mish-激活"></a> 2.4.1 Mish 激活</h3>
<p>下面这个新的激活函数，称为 Swish，表现出比 ReLU 和很多其它激活函数更好的性能。</p>
<p><img src="swish.jpeg" alt="不同  值下的 Swish 激活函数"></p>
<p>Mish 是另一个与 ReLU 和 Swish 非常相似的激活函数。 正如论文所宣称的，Mish 在很多深层网络不同数据集的表现都优于它们。</p>
<p><img src="mish.jpeg" alt="Mish 激活函数"></p>
<p>关于激活函数的详细内容，请看这篇文章 <a href="//2021/03/30/Activation-functions/" title="激活函数详解">激活函数详解</a></p>
<h3 id="242-multi-input-weighted-residual-connections-miwrc"><a class="markdownIt-Anchor" href="#242-multi-input-weighted-residual-connections-miwrc"></a> 2.4.2 Multi-input weighted residual connections (MiWRC)</h3>
<blockquote>
<p>讲了 EfficientDet 中的逆残差块 (inverted residual block)</p>
</blockquote>
<p>在许多 ML 和 DL 问题中，我们学习输入的低维表示。 我们通过创建“信息”瓶颈 (bottleneck) 来提取数据的核心信息。 这迫使我们去发现最重要的信息，这是学习的核心原则。 根据这一原则，一个逆残差块以一个低维表示作为输入，并通过卷积(线性运算)和非线性运算对其进行操作。 但是像 ReLU 这样的非线性部分存在一个主要问题。非线性操作不成比例地拉伸或压缩区域。在这种压缩中，输入可能映射到相同的区域/点。 例如，ReLU 可能在这个低维空间中折叠通道，从而不可避免地丢失信息。 正如论文上引用的:</p>
<blockquote>
<p>为了保持表达能力，在窄层上消除非线性是很重要的。</p>
</blockquote>
<p>为了解决这个问题，我们可以暂时扩展维度(通道数量)。 我们希望在有很多的通道的情况下，在非线性操作之后，信息仍然可以保存在某些通道中。 下面是一个逆残留块的细节:</p>
<p><img src="inverted.jpeg" alt="逆残差模块 Inverted residual block"></p>
<p>如图所示，低维表示首先扩展到 tk 通道。 然后，用轻量级的 3x3 depthwise 卷积滤波。 然后在模块的末端将特性降低到低维。 在高维空间中时，会加上非线性操作。</p>
<p><img src="inverted-block.png" alt="逆残差模块示意图"></p>
<p>残差连接从模块的开始添加到尾部。 左图是传统的残差块，右图是描述的逆残差块。</p>
<p><img src="inverted-compare.png" alt="传统残差模块和逆残差模块对比"></p>
<p>理解 EfficientDet 的关键概念是件好事。 但 EfficientDet 对 YOLOv4的主要贡献是多Multi-input weighted residual connections。 在 EfficientDet 论文中，我们观察到不同的输入特征在不同的分辨率下，对输出特征的贡献是不均匀的。 但是在我们之前的讨论中，我们平等地加上了这些特性。 在 EfficientDet 中，输入特征在合成输出时的权重是不同的:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>=</mo><msub><mi>Σ</mi><mi>i</mi></msub><mfrac><msub><mi>w</mi><mi>i</mi></msub><mrow><mi>ϵ</mi><mo>+</mo><msub><mi>Σ</mi><mi>j</mi></msub><msub><mi>w</mi><mi>j</mi></msub></mrow></mfrac><mo>⋅</mo><msub><mi>I</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\it O =  \Sigma_i \frac{w_i}{\epsilon + \Sigma_jw_j} \cdot {I_i} 
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.079668em;vertical-align:-0.972108em;"></span><span class="mord"><span class="mord mathit">O</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathit">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.308752em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1075599999999999em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathdefault">ϵ</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathit">Σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30875199999999997em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathit">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30875199999999997em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathit">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.308752em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.972108em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord"><span class="mord mathit">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.308752em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>w</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\it w_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord"><span class="mord mathit">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.308752em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathit mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span> 会像其它可训练的参数一样被训练和学习。</p>
<h2 id="25-bag-of-freebies-bof-for-detector"><a class="markdownIt-Anchor" href="#25-bag-of-freebies-bof-for-detector"></a> 2.5 Bag of Freebies (BoF) for detector</h2>
<p>Yolov4检测器的 BoF 功能包括:</p>
<ul>
<li>CIoU-loss</li>
<li>CmBN</li>
<li>DropBlock 正则化</li>
<li>Mosaic 数据增强</li>
<li>Self-Adversarial 训练</li>
<li>消除网格敏感性 (Eliminate grid sensitivity)</li>
<li>用多个 anchors 来对应单个 ground truth</li>
<li>Cosine annealing scheduler</li>
<li>最佳超参数</li>
<li>随机训练形状</li>
</ul>
<h3 id="251-ciou-loss"><a class="markdownIt-Anchor" href="#251-ciou-loss"></a> 2.5.1 CIoU-loss</h3>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>L</mi><mrow><mi>C</mi><mi>I</mi><mi>o</mi><mi>U</mi></mrow></msub><mo>=</mo><mn>1</mn><mo>−</mo><mi>I</mi><mi>o</mi><mi>U</mi><mo>+</mo><mfrac><mrow><msup><mi>ρ</mi><mn>2</mn></msup><mo stretchy="false">(</mo><mi>b</mi><mo separator="true">,</mo><msup><mi>b</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup><mo stretchy="false">)</mo></mrow><msup><mi>c</mi><mn>2</mn></msup></mfrac><mo>+</mo><mi>α</mi><mi>v</mi></mrow><annotation encoding="application/x-tex">L_{CIoU} = 1- IoU + \frac{\rho^2(b,b^{gt})}{c^2} + \alpha v
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.07153em;">C</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.10903em;">U</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.76666em;vertical-align:-0.08333em;"></span><span class="mord mathdefault" style="margin-right:0.07847em;">I</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right:0.10903em;">U</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:2.177108em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">ρ</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7935559999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span></span></span></span></span></p>
<p>其中，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>v</mi><mo>=</mo><mfrac><mn>4</mn><msup><mi>π</mi><mn>2</mn></msup></mfrac><mo stretchy="false">(</mo><mi>a</mi><mi>r</mi><mi>c</mi><mi>t</mi><mi>a</mi><mi>n</mi><mfrac><msup><mi>w</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup><msup><mi>h</mi><mrow><mi>g</mi><mi>t</mi></mrow></msup></mfrac><mo>−</mo><mi>a</mi><mi>r</mi><mi>c</mi><mi>t</mi><mi>a</mi><mi>n</mi><mfrac><mi>w</mi><mi>h</mi></mfrac><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">v = \frac{4}{\pi^2}(arctan\frac{w^{gt}}{h^{gt}} - arctan\frac{w}{h})^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.3482399999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.845108em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">π</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7463142857142857em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.00324em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight">h</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7253428571428571em;"><span style="top:-2.786em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8703428571428571em;"><span style="top:-2.931em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">g</span><span class="mord mathdefault mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.1591079999999998em;vertical-align:-0.345em;"></span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right:0.02778em;">r</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">a</span><span class="mord mathdefault">n</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight">h</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.02691em;">w</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>α</mi><mo>=</mo><mfrac><mi>v</mi><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>I</mi><mi>o</mi><mi>U</mi><mo stretchy="false">)</mo><mo>+</mo><mi>v</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\alpha=\frac{v}{(1-IoU)+v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.0037em;">α</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.215392em;vertical-align:-0.52em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.695392em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathdefault mtight" style="margin-right:0.07847em;">I</span><span class="mord mathdefault mtight">o</span><span class="mord mathdefault mtight" style="margin-right:0.10903em;">U</span><span class="mclose mtight">)</span><span class="mbin mtight">+</span><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
<p>关于各种 IoU 的详细内容，请看这篇文章。<a href="//2021/03/30/IoU-variants/" title="IoU variants">IoU variants</a></p>
<h3 id="252-cmbn"><a class="markdownIt-Anchor" href="#252-cmbn"></a> 2.5.2 CmBN</h3>
<p>原始的 Batch normalization 在一个 mini-batch 收集样本的均值和方差，以对层输入进行白话 (whiten)。 然而，如果 mini-batch size 很小，这些估计就会产生很大的噪声。一个解决方案是在很多 mini-batches 中估计它们。 但是，由于权重在每次迭代中都在变化，在这些权重下收集的统计信息在新的权重下可能变得不准确。 简单地进行平均是不正确的。幸运的是，权重是逐渐变化的。在 Cross-Iteration Batch Normalization(CBN) 中，它使用下面的调整来估计前面 <code>k</code> 次迭代中的统计信息。</p>
<p><img src="CBN.jpeg" alt="CBN 和 BN 的对比"></p>
<p>CmBN 是一个修改过的版本，它只收集单个 batch 内的 mini-batches 之间的统计数据。</p>
<h3 id="253-self-adversarial-training-sat"><a class="markdownIt-Anchor" href="#253-self-adversarial-training-sat"></a> 2.5.3 Self-Adversarial Training (SAT)</h3>
<p>SAT 是一种数据增强技术。首先，它对训练样本进行前向传播。在传统的反向传播算法中，我们通过调整模型权重来改进检测器的性能。在这里，它朝着相反的方向。它改变图像来最大化降低检测器的性能。也就是说，尽管新图片在视觉上看起来是一样的，但它会对当前模型产生对抗性攻击。接下来，使用原始边界框和类标签对模型进行训练。这有助于模型泛化并减少过拟合。</p>
<h3 id="254-消除网格敏感性eliminate-grid-sensitivity"><a class="markdownIt-Anchor" href="#254-消除网格敏感性eliminate-grid-sensitivity"></a> 2.5.4 消除网格敏感性(Eliminate grid sensitivity)</h3>
<p>边界框 b 的计算方法是:</p>
<p><img src="box.jpeg" alt="yolo 中边界框的计算方式"></p>
<p>对于 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>b</mi><mi>x</mi></msub><mo>=</mo><msub><mi>c</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">b_x=c_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.58056em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>b</mi><mi>x</mi></msub><mo>=</mo><msub><mi>c</mi><mi>x</mi></msub><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">b_x=c_x+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.84444em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">b</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.73333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> ，我们需要 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>t</mi><mi>x</mi></msub></mrow><annotation encoding="application/x-tex">t_x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.76508em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathdefault">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 分别有一个巨大的负值和正值。但是我们可以用比例因子 (&gt;1.0) 来乘 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>σ</mi></mrow><annotation encoding="application/x-tex">\it\sigma</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">σ</span></span></span></span></span>，这样更简单。 以下是源代码的更改:</p>
<p><img src="sensitivity.png" alt="源码的更改"></p>
<h3 id="255-multiple-anchors-for-a-single-ground-truth"><a class="markdownIt-Anchor" href="#255-multiple-anchors-for-a-single-ground-truth"></a> 2.5.5 Multiple anchors for a single ground truth</h3>
<p>如果 IoU(ground true，anchor) &gt; IoU 阈值，则使用多个 anchors。 (注意，我还没有足够的信息来确定它在 YOLOv4中的作用。)</p>
<h3 id="256-cosine-annealing-scheduler"><a class="markdownIt-Anchor" href="#256-cosine-annealing-scheduler"></a> 2.5.6 Cosine annealing scheduler</h3>
<p>余弦 schedule 根据余弦函数调整学习率。 它从缓慢降低大的学习率开始。 然后在中途迅速降低学习率，最终学习率降低以微小的斜率告终。</p>
<p><img src="cosine-formation.jpeg" alt="余弦学习率公式"></p>
<p>图表显示了学习率是如何衰减的(学习率 warmup 也在下面的图表中应用)及其对 mAP 的影响。 这可能不是很明显，新的 schedule 有稳定的变化，而不是停滞很长一段时间后再次发生变化。</p>
<p><img src="step-cosine.jpeg" alt="余弦学习率和阶梯学习率的对比"></p>
<h3 id="257-基于遗传算法的超参数选择进化算法"><a class="markdownIt-Anchor" href="#257-基于遗传算法的超参数选择进化算法"></a> 2.5.7 基于遗传算法的超参数选择(进化算法)</h3>
<h3 id="258-随机训练形状"><a class="markdownIt-Anchor" href="#258-随机训练形状"></a> 2.5.8 随机训练形状</h3>
<h2 id="26-bag-of-specials-bos-for-detector"><a class="markdownIt-Anchor" href="#26-bag-of-specials-bos-for-detector"></a> 2.6 Bag of Specials (BoS) for detector</h2>
<p>YOLOv4检测器的 BoS 功能包括:</p>
<ul>
<li>Mish 激活</li>
<li>改进的 SPP-block</li>
<li>改进的 SAM-block</li>
<li>改进的 PAN path-aggregation block</li>
<li>DIoU-NMS</li>
</ul>
<h3 id="261-diou-nms"><a class="markdownIt-Anchor" href="#261-diou-nms"></a> 2.6.1 DIoU-NMS</h3>
<p>NMS 过滤掉其它预测相同目标的边界框，并保留一个最有信心的边界框。</p>
<p>在 NMS 中使用了 DIoU (前面讨论过)作为因子。该方法利用 IoU 和两个边界框中心点之间的距离来抑制冗余边界框。这使得它对于遮挡的情况更加鲁棒。</p>
<p><img src="NMS.jpeg" alt="YOLO 中 NMS 流程"></p>
<h1 id="3-yolo-v4-网络结构分析"><a class="markdownIt-Anchor" href="#3-yolo-v4-网络结构分析"></a> 3. YOLO v4 网络结构分析</h1>
<p><img src="yolov4.jpg" alt="YOLO v4 网络结构"></p>
<blockquote>
<p>这里我们直接从代码上看看这个 CSPDarknet53 什么样子，定义如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">darknet_body</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="string">'''Darknent body having 52 Convolution2D layers'''</span></span><br><span class="line">    x = DarknetConv2D_BN_Mish(<span class="number">32</span>, (<span class="number">3</span>,<span class="number">3</span>))(x)</span><br><span class="line">    x = resblock_body(x, <span class="number">64</span>, <span class="number">1</span>, <span class="keyword">False</span>)</span><br><span class="line">    x = resblock_body(x, <span class="number">128</span>, <span class="number">2</span>)</span><br><span class="line">    x = resblock_body(x, <span class="number">256</span>, <span class="number">8</span>)</span><br><span class="line">    x = resblock_body(x, <span class="number">512</span>, <span class="number">8</span>)</span><br><span class="line">    x = resblock_body(x, <span class="number">1024</span>, <span class="number">4</span>)</span><br><span class="line">    <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>如果把 <strong>堆叠的残差单元</strong> (resblock_body)看成整体的话，那么这个结构和 Darknet53 以及 ResNet 等的确差别不大，特别是 resblock_body 的 num_blocks为 <code>1，2，8，8，4</code>, 和darknet53一模一样。</p>
<p>那么我们解析一下resblock_body的定义，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resblock_body</span><span class="params">(x, num_filters, num_blocks, all_narrow=True)</span>:</span></span><br><span class="line">    <span class="string">'''A series of resblocks starting with a downsampling Convolution2D'''</span></span><br><span class="line">    <span class="comment"># Darknet uses left and top padding instead of 'same' mode</span></span><br><span class="line">    preconv1 = ZeroPadding2D(((<span class="number">1</span>,<span class="number">0</span>),(<span class="number">1</span>,<span class="number">0</span>)))(x)</span><br><span class="line">    preconv1 = DarknetConv2D_BN_Mish(num_filters, (<span class="number">3</span>,<span class="number">3</span>), strides=(<span class="number">2</span>,<span class="number">2</span>))(preconv1)</span><br><span class="line">    shortconv = DarknetConv2D_BN_Mish(num_filters//<span class="number">2</span> <span class="keyword">if</span> all_narrow <span class="keyword">else</span> num_filters, (<span class="number">1</span>,<span class="number">1</span>))(preconv1)</span><br><span class="line">    mainconv = DarknetConv2D_BN_Mish(num_filters//<span class="number">2</span> <span class="keyword">if</span> all_narrow <span class="keyword">else</span> num_filters, (<span class="number">1</span>,<span class="number">1</span>))(preconv1)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(num_blocks):</span><br><span class="line">        y = compose(</span><br><span class="line">                DarknetConv2D_BN_Mish(num_filters//<span class="number">2</span>, (<span class="number">1</span>,<span class="number">1</span>)),</span><br><span class="line">                DarknetConv2D_BN_Mish(num_filters//<span class="number">2</span> <span class="keyword">if</span> all_narrow <span class="keyword">else</span> num_filters, (<span class="number">3</span>,<span class="number">3</span>)))(mainconv)</span><br><span class="line">        mainconv = Add()([mainconv,y])</span><br><span class="line">    postconv = DarknetConv2D_BN_Mish(num_filters//<span class="number">2</span> <span class="keyword">if</span> all_narrow <span class="keyword">else</span> num_filters, (<span class="number">1</span>,<span class="number">1</span>))(mainconv)</span><br><span class="line">    route = Concatenate()([postconv, shortconv])</span><br><span class="line">    <span class="keyword">return</span> DarknetConv2D_BN_Mish(num_filters, (<span class="number">1</span>,<span class="number">1</span>))(route)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>这么一看，和传统的ResBlock差别就出来了，为了大家更清晰地了解结构，我把这个残差单元的结构绘制出来，如下：</p>
<p><img src="resblock_body.jpg" alt="resblock_body 的结构图 (相对于 res_stage)"></p>
<p>对照代码和上面的图片，可以比较清晰地看出来这个 <strong>CSP 残差单元</strong>和 <strong>DarkNet/ResNet 的残差单元</strong>的区别了。</p>
<p>其中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DarknetConv2D_BN_Mish</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    <span class="string">"""Darknet Convolution2D followed by BatchNormalization and LeakyReLU."""</span></span><br><span class="line">    no_bias_kwargs = &#123;<span class="string">'use_bias'</span>: <span class="keyword">False</span>&#125;</span><br><span class="line">    no_bias_kwargs.update(kwargs)</span><br><span class="line">    <span class="keyword">return</span> compose(</span><br><span class="line">        DarknetConv2D(*args, **no_bias_kwargs),</span><br><span class="line">        BatchNormalization(),</span><br><span class="line">        Mish())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DarknetConv2D</span><span class="params">(*args, **kwargs)</span>:</span></span><br><span class="line">    <span class="string">"""Wrapper to set Darknet parameters for Convolution2D."""</span></span><br><span class="line">    darknet_conv_kwargs = &#123;&#125;</span><br><span class="line">    darknet_conv_kwargs[<span class="string">'kernel_initializer'</span>] = keras.initializers.RandomNormal(mean=<span class="number">0.0</span>, stddev=<span class="number">0.01</span>)</span><br><span class="line">    darknet_conv_kwargs[<span class="string">'padding'</span>] = <span class="string">'valid'</span> <span class="keyword">if</span> kwargs.get(<span class="string">'strides'</span>)==(<span class="number">2</span>,<span class="number">2</span>) <span class="keyword">else</span> <span class="string">'same'</span></span><br><span class="line">    darknet_conv_kwargs.update(kwargs)</span><br><span class="line">    <span class="keyword">return</span> Conv2D(*args, **darknet_conv_kwargs)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote></blockquote>
<blockquote>
<p>在 YOLO V4 Keras 代码中，通常将 YOLO HEAD (图片上的橙色块）紧接在 SSP+PAN 后面。为了便于说明，这里我们根据总图上的 process1-5 与三个 YOLO HEAD, 对 SSP+PAN+YOLO HEAD 部分进行解析。</p>
<p><strong>其中 process1 的代码实现为</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> y19 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">1</span>,<span class="number">1</span>))(darknet.output)</span><br><span class="line">y19 = DarknetConv2D_BN_Leaky(<span class="number">1024</span>, (<span class="number">3</span>,<span class="number">3</span>))(y19)</span><br><span class="line">y19 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">1</span>,<span class="number">1</span>))(y19)</span><br><span class="line">maxpool1 = MaxPooling2D(pool_size=(<span class="number">13</span>,<span class="number">13</span>), strides=(<span class="number">1</span>,<span class="number">1</span>), padding=<span class="string">'same'</span>)(y19) <span class="comment">#（19，19）</span></span><br><span class="line">maxpool2 = MaxPooling2D(pool_size=(<span class="number">9</span>,<span class="number">9</span>), strides=(<span class="number">1</span>,<span class="number">1</span>), padding=<span class="string">'same'</span>)(y19) <span class="comment">#（19，19）</span></span><br><span class="line">maxpool3 = MaxPooling2D(pool_size=(<span class="number">5</span>,<span class="number">5</span>), strides=(<span class="number">1</span>,<span class="number">1</span>), padding=<span class="string">'same'</span>)(y19) <span class="comment">#（19，19）</span></span><br><span class="line">y19 = Concatenate()([maxpool1, maxpool2, maxpool3, y19])</span><br><span class="line">y19 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">1</span>,<span class="number">1</span>))(y19)</span><br><span class="line">y19 = DarknetConv2D_BN_Leaky(<span class="number">1024</span>, (<span class="number">3</span>,<span class="number">3</span>))(y19)</span><br><span class="line">y19 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">1</span>,<span class="number">1</span>))(y19)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>显而易见，该进程接受 CSPDarknet53 最终的输出，返回变量 <code>y19</code> (如总图上 process1 所示），这里我们也给出图示，如下：</p>
<p><img src="process1.jpg" alt="process 1"></p>
<p><strong>process2 代码如下</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">y19_upsample = compose(DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">1</span>,<span class="number">1</span>)), UpSampling2D(<span class="number">2</span>))(y19)</span><br><span class="line"></span><br><span class="line"><span class="comment">#38x38 head</span></span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">1</span>,<span class="number">1</span>))(darknet.layers[<span class="number">204</span>].output)</span><br><span class="line">y38 = Concatenate()([y38, y19_upsample])</span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">1</span>,<span class="number">1</span>))(y38)</span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">3</span>,<span class="number">3</span>))(y38)</span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">1</span>,<span class="number">1</span>))(y38)</span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">3</span>,<span class="number">3</span>))(y38)</span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">1</span>,<span class="number">1</span>))(y38)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>即先将上述的 <code>y19</code> 进行上采样至大小 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>38</mn><mi>x</mi><mn>38</mn></mrow><annotation encoding="application/x-tex">38x38</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">8</span><span class="mord mathdefault">x</span><span class="mord">3</span><span class="mord">8</span></span></span></span>，然后再和 CSPDarknet53 的 <code>204</code> 层输出进行堆叠，最后通过一系列 DarknetConv2D_BN_Leaky 模块，获得特征图 <code>y38</code>。</p>
<p><strong>process3</strong></p>
<p>process3 的代码接受 <code>y_38</code> 上采样后的特征图 <code>y38_upsample</code> 以及 darknet 网络的第 <code>131</code> 层输出作为输入，从而获得特征图 <code>y_38</code>，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">y38_upsample = compose(DarknetConv2D_BN_Leaky(<span class="number">128</span>, (<span class="number">1</span>,<span class="number">1</span>)), UpSampling2D(<span class="number">2</span>))(y38)</span><br><span class="line"></span><br><span class="line">y76 = DarknetConv2D_BN_Leaky(<span class="number">128</span>, (<span class="number">1</span>,<span class="number">1</span>))(darknet.layers[<span class="number">131</span>].output)</span><br><span class="line">y76 = Concatenate()([y76, y38_upsample])</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><strong>YOLO HEAD 1</strong></p>
<p>紧接在 process3 之后，代码中使用简单的 5+2 层卷积层对上面的 <code>y76</code> 进行输出。其实这里的卷积层就是图中橙色区域 YOLO HEAD1 ,在后面的 <code>y38_output</code> 和 <code>y19_output</code> 的输出过程中仍能够看到。其中代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#YOLO HEAD 1</span></span><br><span class="line">y76 = DarknetConv2D_BN_Leaky(<span class="number">128</span>, (<span class="number">1</span>,<span class="number">1</span>))(y76)</span><br><span class="line">y76 = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">3</span>,<span class="number">3</span>))(y76)</span><br><span class="line">y76 = DarknetConv2D_BN_Leaky(<span class="number">128</span>, (<span class="number">1</span>,<span class="number">1</span>))(y76)</span><br><span class="line">y76 = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">3</span>,<span class="number">3</span>))(y76)</span><br><span class="line">y76 = DarknetConv2D_BN_Leaky(<span class="number">128</span>, (<span class="number">1</span>,<span class="number">1</span>))(y76)</span><br><span class="line"><span class="comment">#76x76 output</span></span><br><span class="line">y76_output = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">3</span>,<span class="number">3</span>))(y76)</span><br><span class="line">y76_output = DarknetConv2D(num_anchors*(num_classes+<span class="number">5</span>), (<span class="number">1</span>,<span class="number">1</span>))(y76_output)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>该网络最后使用 <code>1x1</code> 卷积输出最大的一张特征图 <code>y76_output</code>，维度为 <code>(76,76,num_anchor*(num_classes+5))</code>。对应结构图中最大的输出特征图（最右边的淡蓝色特征图）。</p>
<p><strong>process4 的代码如下：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#38x38 output</span></span><br><span class="line">y76_downsample = ZeroPadding2D(((<span class="number">1</span>,<span class="number">0</span>),(<span class="number">1</span>,<span class="number">0</span>)))(y76)</span><br><span class="line">y76_downsample = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">3</span>,<span class="number">3</span>), strides=(<span class="number">2</span>,<span class="number">2</span>))(y76_downsample)</span><br><span class="line">y38 = Concatenate()([y76_downsample, y38])</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>这一步骤比较关键，PAN 和 FPN 的差异在于，<strong>FPN</strong> 是<strong>自顶向下</strong>的特征融合，<strong>PAN 在 FPN 的基础上</strong>，多了个<strong>自底向上</strong>的特征融合。具体自底向上的特征融合，就是 process4 完成的，可以看到该步骤先将 <code>y76</code> 下采样至<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>38</mn><mi>x</mi><mn>38</mn></mrow><annotation encoding="application/x-tex">38x38</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">3</span><span class="mord">8</span><span class="mord mathdefault">x</span><span class="mord">3</span><span class="mord">8</span></span></span></span> 大小，再和 <code>y38</code> 堆叠，作为 YOLO HEAD2 的输入。</p>
<p><strong>YOLO HEAD 2</strong></p>
<p>类似于 YOLO HEAD 1, YOLO HEAD 2 也进行一系列卷积运算，获得维度大小为 <code>(38,38,num_anchor*(num_classes+5))</code> 的输出 <code>y38_output</code>，其中代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#YOLO HEAD 2</span></span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">1</span>,<span class="number">1</span>))(y38)</span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">3</span>,<span class="number">3</span>))(y38)</span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">1</span>,<span class="number">1</span>))(y38)</span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">3</span>,<span class="number">3</span>))(y38)</span><br><span class="line">y38 = DarknetConv2D_BN_Leaky(<span class="number">256</span>, (<span class="number">1</span>,<span class="number">1</span>))(y38)</span><br><span class="line"></span><br><span class="line">y38_output = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">3</span>,<span class="number">3</span>))(y38)</span><br><span class="line">y38_output = DarknetConv2D(num_anchors*(num_classes+<span class="number">5</span>), (<span class="number">1</span>,<span class="number">1</span>))(y38_output)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>其中process4和YOLO HEAD2如下图所示。</p>
<p><img src="head2.jpg" alt="process4 和 yolo head2 的流程"></p>
<p><strong>Process 5代码如下</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#19x19 output</span></span><br><span class="line">y38_downsample = ZeroPadding2D(((<span class="number">1</span>,<span class="number">0</span>),(<span class="number">1</span>,<span class="number">0</span>)))(y38)</span><br><span class="line">y38_downsample = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">3</span>,<span class="number">3</span>), strides=(<span class="number">2</span>,<span class="number">2</span>))(y38_downsample)</span><br><span class="line">y19 = Concatenate()([y38_downsample, y19])</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>Process 5 和 process 4 进程类似，不多赘述。后面接上 YOLO HEAD 3。</p>
<p><strong>YOLO HEAD 3</strong></p>
<p>和 YOLO HEAD 1 以及 YOLO HEAD 2 定义几乎类似，YOLO HEAD 3 定义如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">y19 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">1</span>,<span class="number">1</span>))(y19)</span><br><span class="line">y19 = DarknetConv2D_BN_Leaky(<span class="number">1024</span>, (<span class="number">3</span>,<span class="number">3</span>))(y19)</span><br><span class="line">y19 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">1</span>,<span class="number">1</span>))(y19)</span><br><span class="line">y19 = DarknetConv2D_BN_Leaky(<span class="number">1024</span>, (<span class="number">3</span>,<span class="number">3</span>))(y19)</span><br><span class="line">y19 = DarknetConv2D_BN_Leaky(<span class="number">512</span>, (<span class="number">1</span>,<span class="number">1</span>))(y19)</span><br><span class="line"></span><br><span class="line">y19_output = DarknetConv2D_BN_Leaky(<span class="number">1024</span>, (<span class="number">3</span>,<span class="number">3</span>))(y19)</span><br><span class="line">y19_output = DarknetConv2D(num_anchors*(num_classes+<span class="number">5</span>), (<span class="number">1</span>,<span class="number">1</span>))(y19_output)</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>YOLO HEAD 3 输出为 <code>(19,19,num_anchor*(num_classes+5))</code> 的特征图 <code>y19_output</code>.</p>
</blockquote>
<h1 id="引用"><a class="markdownIt-Anchor" href="#引用"></a> 引用</h1>
<ul>
<li><a href="https://jonathan-hui.medium.com/yolov4-c9901eaa8e61" target="_blank" rel="noopener">YOLOv4</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/138510087" target="_blank" rel="noopener">YOLOv4</a></li>
<li><a href="https://blog.csdn.net/qq_48984174/article/details/111680645?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_baidulandingword-0&amp;spm=1001.2101.3001.4242" target="_blank" rel="noopener">CSPDarkNet53学习</a></li>
</ul>
<hr>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">taosean</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://taosean.github.io/2021/03/29/YOLOv4/">https://taosean.github.io/2021/03/29/YOLOv4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://taosean.github.io">taosean's 学习之旅</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/目标检测/">目标检测</a><a class="post-meta__tags" href="/tags/yolo/">yolo</a><a class="post-meta__tags" href="/tags/CSP/">CSP</a><a class="post-meta__tags" href="/tags/CutMix/">CutMix</a><a class="post-meta__tags" href="/tags/数据增强/">数据增强</a><a class="post-meta__tags" href="/tags/DropBlock/">DropBlock</a><a class="post-meta__tags" href="/tags/GIoU/">GIoU</a><a class="post-meta__tags" href="/tags/DIoU/">DIoU</a><a class="post-meta__tags" href="/tags/CIoU/">CIoU</a><a class="post-meta__tags" href="/tags/SPP/">SPP</a><a class="post-meta__tags" href="/tags/PAN/">PAN</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/03/30/Activation-functions/"><i class="fa fa-chevron-left">  </i><span>激活函数详解</span></a></div><div class="next-post pull-right"><a href="/2021/03/19/Make-CNN-shift-invariant-again/"><span>Making Convolutional Networks Shift-Invariant Again</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '9738353720f54c04f11e',
  clientSecret: '1511bb92984c25bbde5236ba58e4673d4ff5f92e',
  repo: 'taosean.github.io',
  owner: 'taosean',
  admin: 'taosean',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(/img/top_img.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2021 By taosean</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">hitokoto</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css"><script src="/js/katex.js"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>