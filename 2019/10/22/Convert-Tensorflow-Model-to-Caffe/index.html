<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="baidu-site-verification" content="L6Lm9d5Crl"/>
  
  
  
  
  <title>将 Tensorflow 模型移植到 Caffe 上 | taosean&#39;s 学习之旅</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="本文主要以 cosine metric learning 工程为例，记录了如何将一个 Tensorflow 模型 (包含 ckpt 文件) 移植到 Caffe 框架下。">
<meta name="keywords" content="Caffe,Tensorflow,Porting,移植,padding,flatten">
<meta property="og:type" content="article">
<meta property="og:title" content="将 Tensorflow 模型移植到 Caffe 上">
<meta property="og:url" content="https://taosean.github.io/2019/10/22/Convert-Tensorflow-Model-to-Caffe/index.html">
<meta property="og:site_name" content="taosean&#39;s 学习之旅">
<meta property="og:description" content="本文主要以 cosine metric learning 工程为例，记录了如何将一个 Tensorflow 模型 (包含 ckpt 文件) 移植到 Caffe 框架下。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://taosean.github.io/2019/10/22/Convert-Tensorflow-Model-to-Caffe/padding_1.png">
<meta property="og:image" content="https://taosean.github.io/2019/10/22/Convert-Tensorflow-Model-to-Caffe/padding_2.png">
<meta property="og:updated_time" content="2019-10-25T07:26:20.547Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="将 Tensorflow 模型移植到 Caffe 上">
<meta name="twitter:description" content="本文主要以 cosine metric learning 工程为例，记录了如何将一个 Tensorflow 模型 (包含 ckpt 文件) 移植到 Caffe 框架下。">
<meta name="twitter:image" content="https://taosean.github.io/2019/10/22/Convert-Tensorflow-Model-to-Caffe/padding_1.png">
  
    <link rel="alternative" href="/atom.xml" title="taosean&#39;s 学习之旅" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.png">
  
  
  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  
  
      <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  
  <!-- 加载特效 -->
    <script src="/js/pace.js"></script>
    <link href="/css/pace/pace-theme-flash.css" rel="stylesheet" />
  <script>
      var yiliaConfig = {
          fancybox: true,
          animate: true,
          isHome: false,
          isPost: true,
          isArchive: false,
          isTag: false,
          isCategory: false,
          open_in_new: false
      }
  </script>
</head>
<body>
  <div id="container">

    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
    <header id="header" class="inner">
        
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

        <a href="/" class="profilepic">
            
            <img lazy-src="/img/avatar.jpg" class="js-avatar">
            
        </a>
        <hgroup>
          <h1 class="header-author"><a href="/">taosean</a></h1>
        </hgroup>
        
        <p class="header-subtitle"  style="color:#aaaaaa">亡命之徒</p><br>
        
        
            <form>
                <input type="text" class="st-default-search-input search" id="local-search-input" placeholder="标题搜索" autocomplete="off">
            </form>
            <div id="local-search-result"></div>
        
        
            <script type="text/javascript">
                (function() {
                    'use strict';
                    function getMatchData(keyword, data) {
                        var matchData = [];
                        for(var i =0;i<data.length;i++){
                            if(data[i].title.toLowerCase().indexOf(keyword)>=0)
                                matchData.push(data[i])
                        }
                        return matchData;
                    }
                    var $input = $('#local-search-input');
                    var $resultContent = $('#local-search-result');
                    $input.keyup(function(){
                        $.ajax({
                            url: '/search.json',
                            dataType: "json",
                            success: function( json ) {
                                var str='<ul class=\"search-result-list\">';
                                var keyword = $input.val().trim().toLowerCase();
                                $resultContent.innerHTML = "";
                                if ($input.val().trim().length <= 0) {
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                var results = getMatchData(keyword, json);
                                if(results.length === 0){
                                    $resultContent.empty();
                                    $('#switch-area').show();
                                    return;
                                }
                                for(var i =0; i<results.length; i++){
                                    str += "<li><a href='"+ results[i].url +"' class='search-result-title'>"+ results[i].title +"</a></li>";
                                }
                                str += "</ul>";
                                $resultContent.empty();
                                $resultContent.append(str);
                                $('#switch-area').hide();
                            }
                        });
                    });
                })();
            </script>
        
        
            <div id="switch-btn" class="switch-btn">
                <div class="icon">
                    <div class="icon-ctn">
                        <div class="icon-wrap icon-house" data-idx="0">
                            <div class="birdhouse"></div>
                            <div class="birdhouse_holes"></div>
                        </div>
                        <div class="icon-wrap icon-ribbon hide" data-idx="1">
                            <div class="ribbon"></div>
                        </div>
                        
                        <div class="icon-wrap icon-link hide" data-idx="2">
                            <div class="loopback_l"></div>
                            <div class="loopback_r"></div>
                        </div>
                        
                        
                        <div class="icon-wrap icon-me hide" data-idx="3">
                            <div class="user"></div>
                            <div class="shoulder"></div>
                        </div>
                        
                    </div>
                </div>
                <div class="tips-box hide">
                    <div class="tips-arrow"></div>
                    <ul class="tips-inner">
                        <li>菜单</li>
                        <li>标签</li>
                        
                        <li>外部链接</li>
                        
                        
                        <li>关于我</li>
                        
                    </ul>
                </div>
            </div>
        
        <div id="switch-area" class="switch-area">
            <div class="switch-wrap">
                <section class="switch-part switch-part1">
                    <nav class="header-menu">
                        <ul>
                        
                            <li><a  href="/archives/">所有文章</a></li>
                        
                            <li><a  href="/about/">关于我</a></li>
                        
                        </ul>
                    </nav>
                    <nav class="header-nav">
                        <ul class="social">
                            
                                <a class="fl github"  target="_blank" href="https://github.com/taosean" title="github">github</a>
                            
                        </ul>
                    </nav>
                </section>
                
                <section class="switch-part switch-part2">
                    <div class="widget tagcloud" id="js-tagcloud">
                        <a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/CNN/" style="font-size: 10px;">CNN</a> <a href="/tags/CPU/" style="font-size: 12.5px;">CPU</a> <a href="/tags/Caffe/" style="font-size: 15px;">Caffe</a> <a href="/tags/Convolution/" style="font-size: 10px;">Convolution</a> <a href="/tags/Debug/" style="font-size: 10px;">Debug</a> <a href="/tags/FLOPs/" style="font-size: 10px;">FLOPs</a> <a href="/tags/Faster-R-CNN/" style="font-size: 12.5px;">Faster R-CNN</a> <a href="/tags/GPU/" style="font-size: 10px;">GPU</a> <a href="/tags/IPC/" style="font-size: 10px;">IPC</a> <a href="/tags/JavaScript/" style="font-size: 12.5px;">JavaScript</a> <a href="/tags/Kalman/" style="font-size: 10px;">Kalman</a> <a href="/tags/Linux/" style="font-size: 10px;">Linux</a> <a href="/tags/Node-js/" style="font-size: 12.5px;">Node.js</a> <a href="/tags/ORB/" style="font-size: 10px;">ORB</a> <a href="/tags/PCA/" style="font-size: 10px;">PCA</a> <a href="/tags/PEX/" style="font-size: 10px;">PEX</a> <a href="/tags/Porting/" style="font-size: 10px;">Porting</a> <a href="/tags/Process/" style="font-size: 10px;">Process</a> <a href="/tags/Python/" style="font-size: 10px;">Python</a> <a href="/tags/Python-layer/" style="font-size: 10px;">Python layer</a> <a href="/tags/RPN/" style="font-size: 12.5px;">RPN</a> <a href="/tags/Release/" style="font-size: 10px;">Release</a> <a href="/tags/SE/" style="font-size: 10px;">SE</a> <a href="/tags/Tensorflow/" style="font-size: 10px;">Tensorflow</a> <a href="/tags/Thread/" style="font-size: 10px;">Thread</a> <a href="/tags/WinAPI/" style="font-size: 10px;">WinAPI</a> <a href="/tags/Windows/" style="font-size: 12.5px;">Windows</a> <a href="/tags/Yolo/" style="font-size: 12.5px;">Yolo</a> <a href="/tags/anchor/" style="font-size: 12.5px;">anchor</a> <a href="/tags/caffe/" style="font-size: 10px;">caffe</a> <a href="/tags/calibration/" style="font-size: 10px;">calibration</a> <a href="/tags/camera/" style="font-size: 10px;">camera</a> <a href="/tags/cpu/" style="font-size: 10px;">cpu</a> <a href="/tags/cuda/" style="font-size: 10px;">cuda</a> <a href="/tags/darknet/" style="font-size: 10px;">darknet</a> <a href="/tags/deformable-RoI-pooling/" style="font-size: 10px;">deformable RoI pooling</a> <a href="/tags/deformable-convolution/" style="font-size: 10px;">deformable convolution</a> <a href="/tags/dependencies/" style="font-size: 10px;">dependencies</a> <a href="/tags/feature-extraction/" style="font-size: 10px;">feature extraction</a> <a href="/tags/file-mapping/" style="font-size: 10px;">file mapping</a> <a href="/tags/flatten/" style="font-size: 10px;">flatten</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/github/" style="font-size: 10px;">github</a> <a href="/tags/gpu/" style="font-size: 12.5px;">gpu</a> <a href="/tags/imaging/" style="font-size: 10px;">imaging</a> <a href="/tags/keypoint/" style="font-size: 10px;">keypoint</a> <a href="/tags/mobile/" style="font-size: 10px;">mobile</a> <a href="/tags/opencv/" style="font-size: 10px;">opencv</a> <a href="/tags/optical-flow/" style="font-size: 10px;">optical flow</a> <a href="/tags/padding/" style="font-size: 10px;">padding</a> <a href="/tags/process/" style="font-size: 10px;">process</a> <a href="/tags/pyinstaller/" style="font-size: 12.5px;">pyinstaller</a> <a href="/tags/python/" style="font-size: 17.5px;">python</a> <a href="/tags/scipy/" style="font-size: 10px;">scipy</a> <a href="/tags/shiv/" style="font-size: 10px;">shiv</a> <a href="/tags/shuffle/" style="font-size: 10px;">shuffle</a> <a href="/tags/thread/" style="font-size: 10px;">thread</a> <a href="/tags/tracking/" style="font-size: 10px;">tracking</a> <a href="/tags/unicode/" style="font-size: 10px;">unicode</a> <a href="/tags/utf-8/" style="font-size: 10px;">utf-8</a> <a href="/tags/version-control/" style="font-size: 10px;">version control</a> <a href="/tags/visual-studio/" style="font-size: 10px;">visual studio</a> <a href="/tags/vs/" style="font-size: 10px;">vs</a> <a href="/tags/xml/" style="font-size: 10px;">xml</a> <a href="/tags/yolo/" style="font-size: 10px;">yolo</a> <a href="/tags/yolov3/" style="font-size: 10px;">yolov3</a> <a href="/tags/中文/" style="font-size: 10px;">中文</a> <a href="/tags/主成分分析/" style="font-size: 10px;">主成分分析</a> <a href="/tags/依赖/" style="font-size: 10px;">依赖</a> <a href="/tags/协同计算/" style="font-size: 10px;">协同计算</a> <a href="/tags/协方差/" style="font-size: 10px;">协方差</a> <a href="/tags/协方差矩阵/" style="font-size: 10px;">协方差矩阵</a> <a href="/tags/单核/" style="font-size: 10px;">单核</a> <a href="/tags/卡尔曼/" style="font-size: 10px;">卡尔曼</a> <a href="/tags/卡尔曼滤波/" style="font-size: 10px;">卡尔曼滤波</a> <a href="/tags/发行/" style="font-size: 10px;">发行</a> <a href="/tags/回归/" style="font-size: 12.5px;">回归</a> <a href="/tags/图像匹配/" style="font-size: 10px;">图像匹配</a> <a href="/tags/图像检索/" style="font-size: 10px;">图像检索</a> <a href="/tags/多核/" style="font-size: 10px;">多核</a> <a href="/tags/安装/" style="font-size: 10px;">安装</a> <a href="/tags/异构/" style="font-size: 10px;">异构</a> <a href="/tags/成像原理/" style="font-size: 10px;">成像原理</a> <a href="/tags/截屏/" style="font-size: 10px;">截屏</a> <a href="/tags/打包/" style="font-size: 10px;">打包</a> <a href="/tags/日文/" style="font-size: 10px;">日文</a> <a href="/tags/权限/" style="font-size: 10px;">权限</a> <a href="/tags/深度学习/" style="font-size: 10px;">深度学习</a> <a href="/tags/特征提取/" style="font-size: 10px;">特征提取</a> <a href="/tags/环境变量/" style="font-size: 10px;">环境变量</a> <a href="/tags/目标检测/" style="font-size: 20px;">目标检测</a> <a href="/tags/相机/" style="font-size: 10px;">相机</a> <a href="/tags/移植/" style="font-size: 10px;">移植</a> <a href="/tags/线程/" style="font-size: 12.5px;">线程</a> <a href="/tags/编码/" style="font-size: 10px;">编码</a> <a href="/tags/网页/" style="font-size: 10px;">网页</a> <a href="/tags/调试/" style="font-size: 10px;">调试</a> <a href="/tags/负载均衡/" style="font-size: 10px;">负载均衡</a> <a href="/tags/进程/" style="font-size: 12.5px;">进程</a> <a href="/tags/进程池/" style="font-size: 10px;">进程池</a> <a href="/tags/进程通信/" style="font-size: 10px;">进程通信</a> <a href="/tags/阻塞/" style="font-size: 10px;">阻塞</a> <a href="/tags/非阻塞/" style="font-size: 10px;">非阻塞</a>
                    </div>
                </section>
                
                
                <section class="switch-part switch-part3">
                    <div id="js-outlinks">
                    
                      <a target="_blank"  class="main-nav-link switch-outlinks-link" href="/xxx">csdn</a><br>
                    
                      <a target="_blank"  class="main-nav-link switch-outlinks-link" href="/xxx">segmentfault</a><br>
                    
                      <a target="_blank"  class="main-nav-link switch-outlinks-link" href="/xxx">简书</a><br>
                    
                    </div>
                </section>
                
                
                
                <section class="switch-part switch-part4">
                
                    <div id="js-aboutme">爱足球，爱图像</div>
                </section>
                
            </div>
        </div>
    </header>
</div>

    </div>

    <div class="mid-col">
      <nav id="mobile-nav">
      <div class="overlay">
          <div class="slider-trigger"></div>
          <h1 class="header-author js-mobile-header hide"><a href="/" title="回到主页">taosean</a></h1>
      </div>
    <div class="intrude-less">
        <header id="header" class="inner">
            <a href="/" class="profilepic">
                
                    <img lazy-src="/img/avatar.jpg" class="js-avatar">
                
            </a>
            <hgroup>
              <h1 class="header-author"><a href="/" title="回到主页">taosean</a></h1>
            </hgroup>
            
            <p class="header-subtitle">亡命之徒</p>
            
            <nav class="header-menu">
                <ul>
                
                    <li><a href="/archives/">所有文章</a></li>
                
                    <li><a href="/about/">关于我</a></li>
                
                <div class="clearfix"></div>
                </ul>
            </nav>
            <nav class="header-nav">
                <div class="social">
                    
                        <a class="github" target="_blank" href="https://github.com/taosean" title="github">github</a>
                    
                </div>
            </nav>
        </header>
    </div>
</nav>
      <div class="body-wrap"><article id="post-Convert-Tensorflow-Model-to-Caffe" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a  href="/2019/10/22/Convert-Tensorflow-Model-to-Caffe/" class="article-date">
      <time datetime="2019-10-22T07:32:49.000Z" itemprop="datePublished">2019-10-22</time>
</a>

    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      将 Tensorflow 模型移植到 Caffe 上
    </h1>
  


      </header>
      
      <div class="article-info article-info-post">
        

        
    <div class="article-tag tagcloud">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Caffe/">Caffe</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Porting/">Porting</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tensorflow/">Tensorflow</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/flatten/">flatten</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/padding/">padding</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/移植/">移植</a></li></ul>
    </div>

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          
        <p>本文主要以 cosine metric learning 工程为例，记录了如何将一个 Tensorflow 模型 (包含 ckpt 文件) 移植到 Caffe 框架下。<br><a id="more"></a></p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><blockquote>
<ol>
<li>根据 Tensorflow 的网络定义源码，手动编写 Caffe 的网络定义文件 *.prototxt.</li>
<li>将训练好的 ckpt 文件中的参数 dump 到磁盘，存为 npy 文件。</li>
<li>使用 pycaffe API, 加载 prototxt 文件，生成 Net 对象。</li>
<li>根据 npy 文件与 Net 对象中网络层的对应关系，将 npy 文件中的值赋给 Net 对象中的参数。</li>
<li>将 Net 对象保存为 caffemodel 文件到磁盘。</li>
</ol>
</blockquote>
<p><br></p>
<h3 id="一些应该注意的点"><a href="#一些应该注意的点" class="headerlink" title="一些应该注意的点"></a>一些应该注意的点</h3><blockquote>
<p><strong>1</strong>. Tensorflow 中的 BN 层对应 Caffe 中的两个层，BatchNorm + Scale. 这是因为 Batch Normalization 算法最后有一个 缩放+偏置 的操作，这就对应 Caffe 中的 Scale 层。通常 Scale 层的缩放参数记为 $\gamma$, 偏置参数记为 $\beta$. 有时候，从 ckpt 模型中 dump 出的 npy 文件没有 BN 层对应的 gamma 值，这可能是因为其在训练时没有使用缩放（batch_norm 函数的 scale 参数设为了 None ），也就是 $\gamma=1$。因此在流程第 4 步时，将相应 shape 的值全为 1 的 ndarray 赋给 Net 对象中 Scale 层对应的 gamma 即可，即 <code>net.params[conv1_scale][0].data[...] = np.ones(bn_beta)</code>. 此外，若 npy 文件中有 BN 层对应的 beta 值，则在 prototxt 文件中对应的 Scale 层应设置 <code>bias_term: true</code>，因为这里的 beta 值就是 bias term. <a href="https://blog.csdn.net/zziahgf/article/details/78843350" target="_blank" rel="noopener">参考1</a> <a href="https://www.cnblogs.com/LaplaceAkuir/p/7811383.html" target="_blank" rel="noopener">参考2</a></p>
</blockquote>
<hr>
<blockquote>
<p><strong>2</strong>. ckpt 中 dump 出的 npy 文件中可能没有某些 Convolution 层的 bias 权重。因此，在 prototxt 文件中，为此 Convolution 层设置 <code>bias_term: false</code>.</p>
</blockquote>
<hr>
<blockquote>
<p><strong>3</strong>. 在从 ckpt 中 dump 出来的参数里，有些可能名如 <code>*/Adam</code>, <code>*/Adam_1</code>，这个是因为模型使用了 Adam 优化器，这两个是对某个参数更新的时候使用的，如果只是在测试阶段进行前向推导，则不需要这两个参数。<a href="https://www.jianshu.com/p/75d8df8511bc" target="_blank" rel="noopener">参考</a><br>但是如果是需要对模型进行 Finetune, 出现大量 Adam 变量丢失的错误，则有可能是 <strong>要恢复的变量的位置</strong> 和 <strong>Adam 优化器的位置</strong> 出错造成的。<a href="https://blog.csdn.net/shwan_ma/article/details/82868751" target="_blank" rel="noopener">【tensorflow】加载pretrained model出现的大量adam变量丢失</a></p>
</blockquote>
<hr>
<blockquote>
<p><strong>4</strong>. 一些 Tensorflow 的项目使用 <code>tf.image.decode_jpeg()</code> 函数来读取 jpg 图像，要注意的是，如果直接使用此函数的默认 <code>dct_method</code> 的话，此函数读取到的值将会跟 <code>cv2.imread()</code> 读取的值不一致。这是因为 <code>tf.image.decode_jpeg()</code> 函数默认会为了解码速度而牺牲一些解码精度。如果想要获得跟 <code>cv2.imread()</code> 相同的结果的话，设置参数 <code>dct_method=&#39;INTEGER_ACCURATE&#39;</code>。<a href="https://github.com/tensorflow/tensorflow/issues/24893#issuecomment-454911098" target="_blank" rel="noopener">参考1</a> <a href="https://stackoverflow.com/a/45520846/8149027" target="_blank" rel="noopener">参考2</a><br>此外，<code>tf.image.decode_jpeg()</code> 函数返回的图像是 <code>RGB</code> 通道的，<code>cv2.imread()</code> 是 <code>BGR</code> 通道。</p>
</blockquote>
<hr>
<blockquote>
<p><strong>5</strong>. <strong>Tensorflow 和 Caffe 在某些操作上的区别</strong><br>&emsp;&emsp;<strong>5-1</strong>. <strong>Feature map 以及 卷积核 维度顺序的区别</strong><br>在 Tensorflow 中，feature map 的默认索引顺序是 <code>NHWC</code>, 卷积核是 <code>HWIO</code>，而 Caffe 中两者的索引顺序是 <code>NCHW</code> 和 <code>OIHW</code>.<br>需要说明的是，如果输入是完全一样的图片，在将图像以及卷积核按各自索引顺序 transpose 好后，后续生成的 feature map 在理论上来说应是完全一样的，它们只是索引的顺序不一样而已(feature map 内部各元素之间的相对顺序是一致的)。<br>&emsp;&emsp;<strong>5-2</strong>.<strong> Flatten 操作的区别</strong><br>据上文所述，同样的输入以及卷积核在不同框架中计算得到的 feature map 是一致的。但是如果要对 feature map (4D) 进行 flatten 操作的话，则此结论可能不成立。因为 flatten 是将 3D 的 feature map 拉伸成 1D, 那么不同的顺序可能就会产生不同的 1D 向量 (内部元素的相对位置可能发生了改变).<br>对同一个 feature map, 若其 shape 为 <code>NHWC</code> （这里的 NHWC 与上文所说的 NHWC 意义不一样，针对某个特定的 feature map, 其 NHWC 的值是固定的）, Tensorflow 的顺序是沿着 <code>C -&gt; W -&gt; H</code>，而 Caffe 的顺序是沿着 <code>W -&gt; H -&gt; C</code>。两者 flatten 的顺序在其各自的输入 feature map 索引顺序中都是 <code>3 -&gt; 2 -&gt; 1</code><br>例如，一个 <code>1x3x3x2</code> 的 feature map.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">data =  [[[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],   | H</span><br><span class="line">          [<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>],   |</span><br><span class="line">          [<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>]],  |</span><br><span class="line">      W  -------------</span><br><span class="line">         [[<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>],</span><br><span class="line">          [<span class="number">13</span>,<span class="number">14</span>,<span class="number">15</span>],</span><br><span class="line">          [<span class="number">16</span>,<span class="number">17</span>,<span class="number">18</span>]]]</span><br><span class="line"></span><br><span class="line">Tensorflow: [<span class="number">1</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">11</span>, <span class="number">3</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">13</span>, ... ]</span><br><span class="line">Caffe: [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, ...]</span><br></pre></td></tr></table></figure></p>
<p>由于 两者 flatten 的顺序在其各自的输入 feature map 索引顺序中都是 <code>3 -&gt; 2 -&gt; 1</code>，因此若这两个 flatten 的输入是一样的话，则它们的输出也是一样的。由于 Caffe 中没有类似 Transpose 这样的层，因此我采取使用 pycaffe 将前向 inference 后 Flatten 层的输入取出，用 numpy 进行 transpose 后，再重新赋给 Flatten 层当输入，然后再次调用 pycaffe 的接口 <code>net.forward(start=&#39;&#39;, end=&#39;&#39;)</code> 指定从某个层开始前向传播，这里就指定 start 参数为 Flatten 层的 name. 这样，即可在 Caffe 中得到与 Tensorflow 中同样的 Flatten 层输出。<a href="https://github.com/BVLC/caffe/issues/2725#issue-93930312" target="_blank" rel="noopener">net.forward 指定起点</a><br>Caffe 的 Flatten 层有 <code>axis</code>, <code>end_axis</code> 两个参数，但是我无论如何设置都无法在不对输入进行 transpose 的情况下得到与 Tensorflow 一样的结果。也许是我没理解对这两个参数的意义。<a href="https://caffe.berkeleyvision.org/tutorial/layers/flatten.html" target="_blank" rel="noopener">参考1</a> <a href="https://stackoverflow.com/a/40401460/8149027" target="_blank" rel="noopener">参考2</a></p>
<p>&emsp;&emsp;<strong>5-3</strong>.<strong> Padding 操作的区别</strong><br>Caffe 中的所有 padding 操作都是对称的，也就是说如果设置 <code>pad_w=1</code> 则会在 feature map 的左右两边都 pad 一个像素。但是 Tensorflow 不是如此，有可能出现左边 pad 1, 右边 pad 2，或者上边 pad 1,下边 pad 2 的情况。因此，在移植时，要保持在 Tensorflow 和 Caffe 中的 padding 方式都一样，这样才能得到相同的结果。<br>下面讨论 Caffe 的 padding 与 Tensorflow 中 <code>SAME</code> padding 方式的差异。<br>正常情况下，如果 <code>kernel_size=3, stride=1</code> 那么 <code>SAME</code> padding 模式会保持输入输出的尺寸相同，因此，需要在输入的上下左右各 pad 1 个像素。这时，在 Caffe 里只要设置 <code>pad: 1</code> 就行，这样两者 pad 的结果就是一样的了。<br>但是，如果遇到 $stride\neq1$ 的情况，情况就变得复杂。有可能两个框架某个 Convolution 或者 Pooling 操作的输入输出尺寸都一样，但是数值却不同。如下图所示 <a href="https://github.com/Microsoft/MMdnn/wiki/Error-in-mobilenet-conversion-from-Tensorflow-to-Caffe-Different-way-of-padding#the-reason-of-the-inconsistent-shapes-is-due-to-symmetric-padding-in-caffe" target="_blank" rel="noopener">来源</a><br><img src="padding_1.png" alt=""><br><img src="padding_2.png" alt=""><br>在 Tensorflow 中, <code>SAME</code> padding 模式的策略是: <a href="https://stackoverflow.com/a/53820765/8149027" target="_blank" rel="noopener">来源</a></p>
<blockquote>
<p>First, consider the <code>SAME</code> padding scheme. A detailed explanation of the reasoning behind it is given in these notes. Here, we summarize the mechanics of this padding scheme. When using ‘SAME’, the output height and width are computed as:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">out_height = ceil(float(in_height) / float(strides[<span class="number">1</span>]))</span><br><span class="line">out_width  = ceil(float(in_width) / float(strides[<span class="number">2</span>]))</span><br></pre></td></tr></table></figure></p>
<p>The total padding applied along the height and width is computed as:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SAME padding 长度计算</span></span><br><span class="line"><span class="keyword">if</span> (in_height % strides[<span class="number">1</span>] == <span class="number">0</span>):</span><br><span class="line">  pad_along_height = max(filter_height - strides[<span class="number">1</span>], <span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  pad_along_height = max(filter_height - (in_height % strides[<span class="number">1</span>]), <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (in_width % strides[<span class="number">2</span>] == <span class="number">0</span>):</span><br><span class="line">  pad_along_width = max(filter_width - strides[<span class="number">2</span>], <span class="number">0</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  pad_along_width = max(filter_width - (in_width % strides[<span class="number">2</span>]), <span class="number">0</span>)</span><br></pre></td></tr></table></figure></p>
<p>Finally, the padding on the top, bottom, left and right are:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pad_top = pad_along_height // <span class="number">2</span></span><br><span class="line">pad_bottom = pad_along_height - pad_top</span><br><span class="line">pad_left = pad_along_width // <span class="number">2</span></span><br><span class="line">pad_right = pad_along_width - pad_left</span><br></pre></td></tr></table></figure></p>
<p>Note that the division by 2 means that there might be cases when the padding on both sides (top vs bottom, right vs left) are off by one. In this case, the bottom and right sides always get the one additional padded pixel. For example, when pad_along_height is 5, we pad 2 pixels at the top and 3 pixels at the bottom. Note that this is different from existing libraries such as cuDNN and Caffe, which explicitly specify the number of padded pixels and always pad the same number of pixels on both sides.</p>
<p>For the <code>VALID</code> scheme, the output height and width are computed as:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">out_height = ceil(float(in_height - filter_height + <span class="number">1</span>) / float(strides[<span class="number">1</span>]))</span><br><span class="line">out_width  = ceil(float(in_width - filter_width + <span class="number">1</span>) / float(strides[<span class="number">2</span>]))</span><br></pre></td></tr></table></figure></p>
<p>and no padding is used.</p>
</blockquote>
<p>在我的实例中，由于最后进入 Flatten 层的 feature map 需要是 <code>13x13</code> 的，而输入图像此前一共经过了 3 次下采样，一次 MAX Pool, 两次 Convolution, 都是 <code>kernel_size=3, stride=2</code>。因此，如何使这三次操作的 padding 操作在两个框架中一致就成了关键问题。由于在 SAME padding 中，<br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;                  <code>out_height = ceil(float(in_height) / float(strides[1])),</code><br>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;                  <code>out_width  = ceil(float(in_width) / float(strides[2]))</code><br>因此，这三次下采样操作的输入尺寸存在这些可能性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">              13                      &lt;-  经过第二次 Conv, stride=2</span><br><span class="line">          /         \</span><br><span class="line">         /           \</span><br><span class="line">       25            26               &lt;-  经过第一次 Conv, stride=2</span><br><span class="line">    /     \       /     \</span><br><span class="line">   49     50     51      52           &lt;-   经过 MAX Pooling</span><br><span class="line">  /  \   /  \   /   \   /   \</span><br><span class="line">97   98 99 100 101 102 103 104        &lt;-      输入图像</span><br></pre></td></tr></table></figure>
<p>由于 Caffe 只能进行对称 padding，因此要选择一个合适的输入图像尺寸，使得在这三次操作时 Tensorflow 不会出现 padding 不对称的情况 (因为这在 Caffe 中无法实现)。<br>根据上段 <code>SAME padding 长度计算部分的公式</code>，我们要使得 <code>pad_along_width，pad_along_height</code> 的数值为 <strong>偶数</strong>，这样才能对称。因此，要使得 <strong><code>in_height % strides[1] != 0, in_width % strides[2] != 0</code></strong>。由于 <code>strides[1]=2</code>，因此，<code>in_height, in_width</code> 必须是 <strong>奇数</strong>。这样，就可以得到每次操作前的输入尺寸分别是 <code>97 -&gt; 49 -&gt; 25 -&gt; 13</code>。这样，在每次操作时，SAME padding 都会为 feature map 在空间维度上四周各 pad 一个像素。而在 Caffe 的对应层的定义里，只要设置 <code>pad: 1</code> 即可。</p>
</blockquote>
<hr>
<blockquote>
<p><strong>6</strong>. 关于 Tensorflow 中获取 Graph 中所有节点名称以及 ckpt 文件中的变量。<br>&emsp;&emsp;<strong>6.1</strong>.<strong>读取 ckpt 中的变量</strong> <a href="https://www.jianshu.com/p/75d8df8511bc" target="_blank" rel="noopener">参考</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf;</span><br><span class="line"></span><br><span class="line"> reader = tf.train.NewCheckpointReader(<span class="string">"/path/to/model.ckpt"</span>)</span><br><span class="line"> variables = reader.get_variable_to_shape_map()</span><br><span class="line"> <span class="keyword">for</span> key <span class="keyword">in</span> variables:</span><br><span class="line">      w = reader.get_tensor(key)</span><br></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<strong>6.2</strong>. <strong>获取 Graph 中的所有结点名称，并计算得到某节点的值</strong> <a href="https://www.jianshu.com/p/3cee7ca5ebd8" target="_blank" rel="noopener">参考</a><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">all_op_names = [n.name <span class="keyword">for</span> n <span class="keyword">in</span> tf.get_default_graph().as_graph_def().node]</span><br><span class="line">conv1_op = tf.get_default_graph.get_tensor_by_name(<span class="string">'a_tensor_name_from_above_line:0'</span>)  <span class="comment"># 注意要在名称后面加 :0</span></span><br><span class="line">conv1_value = sess.run(conv1_op, feed_dict=&#123;...&#125;)</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p><br></p>
<h3 id="dump-ckpt-中的参数以及生成-caffemodel-的两个脚本"><a href="#dump-ckpt-中的参数以及生成-caffemodel-的两个脚本" class="headerlink" title="dump ckpt 中的参数以及生成 caffemodel 的两个脚本"></a>dump ckpt 中的参数以及生成 caffemodel 的两个脚本</h3><p><a href="dump.py">dump ckpt</a><br><a href="tf2caffe.py">生成 caffemodel</a></p>

      
    </div>
    
  </div>
  
    <br><br>

    <div class="copyright">
        <p><span>本文标题:</span><a  href="/2019/10/22/Convert-Tensorflow-Model-to-Caffe/">将 Tensorflow 模型移植到 Caffe 上</a></p>
        <p><span>文章作者:</span><a  href="/" title="访问 taosean 的个人博客">taosean</a></p>
        <p><span>发布时间:</span>2019年10月22日 - 15时32分</p>
        <p><span>最后更新:</span>2019年10月25日 - 15时26分</p>
        <p>
            <span>原始链接:</span><a class="post-url" href="/2019/10/22/Convert-Tensorflow-Model-to-Caffe/" title="将 Tensorflow 模型移植到 Caffe 上">https://taosean.github.io/2019/10/22/Convert-Tensorflow-Model-to-Caffe/</a>
            <span class="copy-path" data-clipboard-text="原文: https://taosean.github.io/2019/10/22/Convert-Tensorflow-Model-to-Caffe/　　作者: taosean" title=""></span>
        </p>
        <p>
            <span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" title="中国大陆 (CC BY-NC-SA 3.0 CN)" target = "_blank">"署名-非商用-相同方式共享 3.0"</a> 转载请保留原文链接及作者。
        </p>
    </div>



<nav id="article-nav">
  
    <a  href="/2019/10/29/Packaging-Python/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          打包 Python 工程
        
      </div>
    </a>
  
  
    <a  href="/2019/07/04/Kalman-Filter/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">卡尔曼滤波</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>


  
</article>

    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#流程"><span class="toc-number">1.</span> <span class="toc-text">流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一些应该注意的点"><span class="toc-number">2.</span> <span class="toc-text">一些应该注意的点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dump-ckpt-中的参数以及生成-caffemodel-的两个脚本"><span class="toc-number">3.</span> <span class="toc-text">dump ckpt 中的参数以及生成 caffemodel 的两个脚本</span></a></li></ol>
</div>
<style>
    .left-col .switch-btn {
        display: none;
    }
    .left-col .switch-area {
        display: none;
    }
</style>
<input type="button" id="tocButton" value="隐藏目录"  title="点击按钮隐藏或者显示文章目录">

<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

<script>
    var valueHide = "隐藏目录";
    var valueShow = "显示目录";
    if ($(".left-col").is(":hidden")) {
        $("#tocButton").attr("value", valueShow);
    }
    $("#tocButton").click(function() {
        if ($("#toc").is(":hidden")) {
            $("#tocButton").attr("value", valueHide);
            $("#toc").slideDown(320);
            $(".switch-btn, .switch-area").fadeOut(300);
        }
        else {
            $("#tocButton").attr("value", valueShow);
            $("#toc").slideUp(350);
            $(".switch-btn, .switch-area").fadeIn(500);
        }
    })
    if ($(".toc").length < 1) {
        $("#toc, #tocButton").hide();
        $(".switch-btn, .switch-area").show();
    }
</script>

    <style>
        .toc {
            white-space: nowrap;
            overflow-x: hidden;
        }
    </style>
    <script>
        $(document).ready(function() {
            $(".toc li a").mouseover(function() {
                var title = $(this).attr('href');
                $(this).attr("title", title);
            });
        })
    </script>






    



    <div class="scroll" id="post-nav-button">
        
            <a  href="/2019/10/29/Packaging-Python/" title="上一篇: 打包 Python 工程">
                <i class="fa fa-angle-left"></i>
            </a>
        
        <a title="文章列表"><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
        
            <a  href="/2019/07/04/Kalman-Filter/" title="下一篇: 卡尔曼滤波">
                <i class="fa fa-angle-right"></i>
            </a>
        
    </div>
    <ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/10/29/Packaging-Python/">打包 Python 工程</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/22/Convert-Tensorflow-Model-to-Caffe/">将 Tensorflow 模型移植到 Caffe 上</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/04/Kalman-Filter/">卡尔曼滤波</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/26/Heterogeneous-Computing/">(转载) 浅谈多节点 CPU+GPU 协同计算负载均衡性设计</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/26/Cxx-Related/">一些 C++ 相关的概念和操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/14/Process-and-Thread/">进程和线程及相关概念</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/03/light-weight-CNN-operations/">轻量卷积神经网络的一些操作</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/31/Git-Usage/">Git的使用流程</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/31/AlexyAB-Darknet/">AlexeyAB/Darknet 的使用经验总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/20/Build-opencv-with-GPU/">OpenCV 4.0.1 + CUDA 8.0 + Visual Studio 2015 + Win10</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/02/Pyinstaller-with-Scipy/">Pyinstaller with Scipy</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/25/optical-flow/">光流法</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/25/covariance-and-covariance-matrix/">协方差及协方差矩阵</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/07/linux-install-setting-process/">Centos 系统下深度学习环境配置及 tensorflow 安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/03/Inter-Process-Communication-by-Shared-Memory-on-Windows/">Windows 下利用共享内存实现进程间通信</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/26/Visual-Studio-Configuration/">Visual Studio 环境变量配置</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/15/camera-calibration/">相机成像原理和参数标定</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/14/tensorflow-1-x-cookbook/">tensorflow-1.x-cookbook 读书笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/13/ORB-Feature/">ORB 特征提取</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/Faster-RCNN-Python-layer/">Faster RCNN 中自定义 Python 层的作用理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/24/encoding-problem/">python 中关于字符的编码方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/09/Convert-python-project-to-exe/">将包含 caffe 的 python 工程打包成一个 exe 文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/04/Linux-caffe-path-setting/">Linux 下 Caffe 的路径设置问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/27/Caffe-install/">Windows 下 Caffe 安装及测试</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/22/python-thread/">python 多线程模块 threading 及 多进程模块 multiprocessing</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/15/jupyter-add-kernel/">jupyter notebook 增加内核</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/08/vim/">vim</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/07/Deformable-Convolutional-Networks/">Deformable Convolutional Networks 论文理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/05/07/FPN/">FPN</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/25/Faster-R-CNN/">RPN 中的 loss 理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/20/Yolo-v2/">Yolo v2 论文理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/19/Yolo/">Yolo v1 论文理解</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/node-random-number-service/">使用 Node.js 生成随机数的服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/Webpage2Picture/">如何截取网页长屏</a></li></ul>
    
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

    <script>
        $(".post-list").addClass("toc-article");
        // $(".post-list-item a").attr("target","_blank");
        $("#post-nav-button > a:nth-child(2)").click(function() {
            $(".fa-bars, .fa-times").toggle();
            $(".post-list").toggle(300);
            if ($(".toc").length > 0) {
                $("#toc, #tocButton").toggle(200, function() {
                    if ($(".switch-area").is(":visible")) {
                        $("#toc, .switch-btn, .switch-area").toggle();
                        $("#tocButton").attr("value", valueHide);
                        }
                    })
            }
            else {
                $(".switch-btn, .switch-area").fadeToggle(300);
            }
        })
    </script>




    <script>
        
    </script>

</div>
      <footer id="footer">
    <div class="outer">
        <div id="footer-info">
            <div class="footer-left">
                &copy; 2020 taosean
            </div>
            <div class="footer-right">
                <a href="https://github.com/taosean" target="_blank">Github</a> of taosean
                <!-- <a href="http://hexo.io/" target="_blank">Hexo &nbsp;&nbsp;</a> -->
            </div>
        </div>

        


        <!-- <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script> -->


    </div>
</footer>

    </div>

    
<script src="https://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>

<script src="/js/main.js"></script>

    <script>
        $(document).ready(function() {
            var backgroundnum = 1;
            var backgroundimg = "url(/background/bg-x.jpg)".replace(/x/gi, Math.ceil(Math.random() * backgroundnum));
            $("#mobile-nav").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
            $(".left-col").css({"background-image": backgroundimg,"background-size": "cover","background-position": "center"});
        })
    </script>


<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'xxxxx', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->



	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?xxxxxx";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>



<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<div class="scroll" id="scroll">
    <a href="#"><i class="fa fa-arrow-up"></i></a>
    <a href="#comments"><i class="fa fa-comments-o"></i></a>
    <a href="#footer"><i class="fa fa-arrow-down"></i></a>
</div>
<script>
    $(document).ready(function() {
        if ($("#comments").length < 1) {
            $("#scroll > a:nth-child(2)").hide();
        };
    })
</script>



<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>

  <script language="javascript">
    $(function() {
        $("a[title]").each(function() {
            var a = $(this);
            var title = a.attr('title');
            if (title == undefined || title == "") return;
            a.data('title', title).removeAttr('title').hover(
            function() {
                var offset = a.offset();
                $("<div id=\"anchortitlecontainer\"></div>").appendTo($("body")).html(title).css({
                    top: offset.top - a.outerHeight() - 15,
                    left: offset.left + a.outerWidth()/2 + 1
                }).fadeIn(function() {
                    var pop = $(this);
                    setTimeout(function() {
                        pop.remove();
                    }, pop.text().length * 800);
                });
            }, function() {
                $("#anchortitlecontainer").remove();
            });
        });
    });
</script>



  </div>
</body>
</html>
